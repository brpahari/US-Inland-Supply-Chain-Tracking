<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>Mississippi River Water Level, Locks 27 Barge Traffic, Rail Congestion, US Inland Logistics Risk Dashboard</title>
  <meta name="description" content="US inland freight early warning dashboard. Tracks Mississippi River stage and discharge, Locks 27 barge traffic, and Class I rail congestion to estimate supply chain risk for grain and bulk commodities." />
  <meta name="keywords" content="Mississippi River water level, river stage, river discharge, Locks 27 barge traffic, barge volumes, inland logistics, grain transportation, rail congestion, Union Pacific dwell, BNSF train speed, supply chain risk dashboard" />

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #0b0f14; color: #e7eef7; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 22px; }
    h1 { font-size: 22px; margin: 0 0 6px 0; }
    h2 { font-size: 15px; margin: 0 0 10px 0; opacity: 0.95; }
    .sub { opacity: 0.8; font-size: 13px; margin-bottom: 18px; }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 14px; }
    .card { background: #111926; border: 1px solid #1f2a3a; border-radius: 12px; padding: 14px; }
    .span-12 { grid-column: span 12; }
    .span-8 { grid-column: span 8; }
    .span-6 { grid-column: span 6; }
    .span-4 { grid-column: span 4; }
    .span-3 { grid-column: span 3; }
    .kpi { display: flex; align-items: baseline; justify-content: space-between; gap: 10px; }
    .kpi .label { opacity: 0.75; font-size: 12px; }
    .kpi .value { font-size: 26px; font-weight: 700; letter-spacing: 0.3px; }
    .pill { display: inline-block; padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight: 650; border: 1px solid transparent; }
    .pill.low { background: rgba(32, 180, 84, 0.12); border-color: rgba(32, 180, 84, 0.35); color: #6ee7a8; }
    .pill.moderate { background: rgba(255, 196, 0, 0.12); border-color: rgba(255, 196, 0, 0.35); color: #ffd36b; }
    .pill.critical { background: rgba(255, 79, 79, 0.12); border-color: rgba(255, 79, 79, 0.35); color: #ff9a9a; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: space-between; }
    .muted { opacity: 0.8; font-size: 12px; }
    a { color: #9cc7ff; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .table th, .table td { padding: 10px 8px; border-bottom: 1px solid #1f2a3a; text-align: left; }
    .table th { opacity: 0.75; font-weight: 600; }
    .warn { color: #ffd36b; }
    .ok { color: #6ee7a8; }
    .bad { color: #ff9a9a; }
    canvas { width: 100% !important; height: 320px !important; }
    .smallcanvas { height: 220px !important; }
    .controls { display: flex; gap: 10px; flex-wrap: wrap; }
    select, button { background: #0e1520; color: #e7eef7; border: 1px solid #1f2a3a; border-radius: 10px; padding: 8px 10px; font-size: 13px; }
    button { cursor: pointer; }
    .note { margin-top: 8px; padding: 10px 12px; border-radius: 10px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); }
    @media (max-width: 950px) {
      .span-8, .span-6, .span-4, .span-3 { grid-column: span 12; }
      canvas { height: 280px !important; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="row">
      <div>
        <h1>US Inland Logistics Risk Monitor</h1>
        <div class="sub">
          Mississippi River water level and discharge, Locks 27 barge traffic, and rail congestion signals for inland freight and grain supply chain risk
        </div>
      </div>
      <div class="muted" id="updated"></div>
    </div>

    <div class="grid">
      <div class="card span-3">
        <div class="kpi">
          <div>
            <div class="label">Supply chain risk score</div>
            <div class="value" id="riskScore">–</div>
          </div>
          <div id="riskPill" class="pill low">LOW</div>
        </div>
        <div class="muted" id="primaryDriver">Primary driver –</div>
      </div>

      <div class="card span-3">
        <div class="kpi">
          <div>
            <div class="label" id="riverKpiLabel">St Louis river stage</div>
            <div class="value" id="stlStage">–</div>
          </div>
        </div>
        <div class="muted" id="stlDelta">7 day delta –</div>
      </div>

      <div class="card span-3">
        <div class="kpi">
          <div>
            <div class="label">Locks 27 barge traffic</div>
            <div class="value" id="locksVal">–</div>
          </div>
        </div>
        <div class="muted" id="locksDelta">4 week delta –</div>
      </div>

      <div class="card span-3">
        <div class="kpi">
          <div>
            <div class="label">UP terminal dwell change</div>
            <div class="value" id="upDwellDelta">–</div>
          </div>
        </div>
        <div class="muted">4 week delta hours</div>
      </div>

      <div class="card span-8">
        <div class="row">
          <div style="font-weight:700;">Mississippi River trend</div>
          <div class="controls">
            <select id="riverSite">
              <option value="st_louis_mo">St Louis Missouri</option>
              <option value="memphis_tn">Memphis Tennessee</option>
            </select>
            <select id="riverMetric">
              <option value="gage_height_ft">River stage feet</option>
              <option value="discharge_cfs">River discharge cfs</option>
            </select>
            <button id="refreshBtn">Refresh</button>
          </div>
        </div>

        <div class="muted" style="margin-top:6px;">Plots the 7 day time series from river_status.json</div>
        <canvas id="riverChart"></canvas>
        <div class="note muted" id="riverNote" style="display:none;"></div>
      </div>

      <div class="card span-4">
        <div style="font-weight:700;">Risk driver breakdown</div>
        <div class="muted" style="margin-top:6px;">Points contribution to total risk score</div>
        <canvas id="driverChart" class="smallcanvas"></canvas>
        <div class="muted" style="margin-top:10px;">
          Data feeds
          <a href="data/composite_risk_score.json" target="_blank" rel="noreferrer">risk json</a>
          <span> </span>
          <a href="data/river_status.json" target="_blank" rel="noreferrer">river json</a>
          <span> </span>
          <a href="data/barge_status.json" target="_blank" rel="noreferrer">barge json</a>
          <span> </span>
          <a href="data/rail_status.json" target="_blank" rel="noreferrer">rail json</a>
        </div>
      </div>

      <div class="card span-6">
        <div style="font-weight:700;">Locks 27 history</div>
        <div class="muted" style="margin-top:6px;">Filters out trailing zero values for plotting</div>
        <canvas id="locksChart" class="smallcanvas"></canvas>
      </div>

      <div class="card span-6">
        <div style="font-weight:700;">Rail history</div>
        <div class="row" style="margin-top:6px;">
          <div class="muted">From rail_weekly.csv</div>
          <div class="controls">
            <select id="railCarrier">
              <option value="UP">Union Pacific</option>
              <option value="BNSF">BNSF</option>
            </select>
            <select id="railMetric">
              <option value="terminal_dwell_hours">Terminal dwell hours</option>
              <option value="train_speed_mph">Average train speed mph</option>
            </select>
          </div>
        </div>
        <canvas id="railChart" class="smallcanvas"></canvas>
      </div>

      <div class="card span-12">
        <div class="row">
          <div style="font-weight:700;">Latest signals</div>
          <div class="muted">Quick audit view</div>
        </div>
        <table class="table" id="signalsTable"></table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    const fmt = new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 });

    function pillFor(level) {
      const el = document.getElementById("riskPill");
      el.classList.remove("low", "moderate", "critical");
      const up = String(level || "").toUpperCase();
      if (up === "CRITICAL") { el.classList.add("critical"); el.textContent = "CRITICAL"; return; }
      if (up === "MODERATE") { el.classList.add("moderate"); el.textContent = "MODERATE"; return; }
      el.classList.add("low"); el.textContent = "LOW";
    }

    async function getJson(path) {
      const r = await fetch(path, { cache: "no-store" });
      if (!r.ok) throw new Error("Fetch failed " + path);
      return await r.json();
    }

    async function getText(path) {
      const r = await fetch(path, { cache: "no-store" });
      if (!r.ok) throw new Error("Fetch failed " + path);
      return await r.text();
    }

    function parseCsv(text) {
      const lines = text.trim().split(/\r?\n/);
      if (lines.length < 2) return [];
      const headers = lines[0].split(",").map(s => s.trim());
      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(",");
        const obj = {};
        for (let j = 0; j < headers.length; j++) obj[headers[j]] = (cols[j] ?? "").trim();
        rows.push(obj);
      }
      return rows;
    }

    function asNum(x) {
      const v = Number(x);
      return Number.isFinite(v) ? v : null;
    }

    function lastNonZero(points) {
      for (let i = points.length - 1; i >= 0; i--) {
        if (points[i].v != null && points[i].v !== 0) return points[i];
      }
      return null;
    }

    function toShortTime(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return String(iso);
      return d.toISOString().slice(0, 10);
    }

    let charts = {
      riverChart: null,
      driverChart: null,
      locksChart: null,
      railChart: null,
    };

    function makeLineChart(canvasId, labels, data, label) {
      const ctx = document.getElementById(canvasId);
      const old = charts[canvasId];
      if (old) old.destroy();

      const c = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label,
            data,
            tension: 0.25,
            pointRadius: 0,
            borderWidth: 2,
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true, labels: { color: "#e7eef7" } },
            tooltip: { enabled: true }
          },
          scales: {
            x: { ticks: { color: "#b9c7da", maxTicksLimit: 10 }, grid: { color: "rgba(255,255,255,0.06)" } },
            y: { ticks: { color: "#b9c7da" }, grid: { color: "rgba(255,255,255,0.06)" } }
          }
        }
      });

      charts[canvasId] = c;
    }

    function makeBarChart(canvasId, labels, data) {
      const ctx = document.getElementById(canvasId);
      const old = charts[canvasId];
      if (old) old.destroy();

      const c = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Driver points",
            data,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false }, tooltip: { enabled: true } },
          scales: {
            x: { ticks: { color: "#b9c7da" }, grid: { color: "rgba(255,255,255,0.06)" } },
            y: { ticks: { color: "#b9c7da" }, grid: { color: "rgba(255,255,255,0.06)" }, suggestedMax: 50 }
          }
        }
      });

      charts[canvasId] = c;
    }

    function setSignalsTable(risk, river, barge, rail) {
      const tbl = document.getElementById("signalsTable");
      const rows = [];

      const siteKey = document.getElementById("riverSite").value;
      const metricKey = document.getElementById("riverMetric").value;

      const metricObj = river?.sites?.[siteKey]?.[metricKey];
      rows.push(["River metric", metricKey === "gage_height_ft" ? "stage feet" : "discharge cfs", ""]);
      rows.push(["River latest", metricObj?.latest_value ?? "–", risk?.primary_driver === "river" ? "driver" : ""]);
      rows.push(["River delta 7d", metricObj?.delta_7d ?? "–", ""]);

      const l27 = barge?.locks_27;
      rows.push(["Locks 27 latest", l27?.value ?? "–", risk?.primary_driver === "barge" ? "driver" : ""]);
      rows.push(["Locks 27 delta 4w", l27?.delta_4w ?? "–", ""]);

      const upD = rail?.carriers?.UP?.metrics?.terminal_dwell_hours?.delta_4w;
      rows.push(["UP dwell delta 4w hours", upD ?? "–", risk?.primary_driver === "rail" ? "driver" : ""]);

      const drivers = risk?.drivers || [];
      for (const d of drivers) rows.push(["Driver points " + d.name, d.score, ""]);

      let html = "<thead><tr><th>Signal</th><th>Value</th><th>Note</th></tr></thead><tbody>";
      for (const r of rows) {
        const note = r[2] ? "<span class='warn'>" + r[2] + "</span>" : "";
        html += "<tr><td>" + r[0] + "</td><td>" + r[1] + "</td><td>" + note + "</td></tr>";
      }
      html += "</tbody>";
      tbl.innerHTML = html;
    }

    function pickRiverSeries(river, siteKey, metricKey) {
      const site = river?.sites?.[siteKey];
      if (!site) return { series: [], note: "Missing site data" };

      const wanted = site?.[metricKey];
      if (wanted?.series_7d?.length) return { series: wanted.series_7d, note: "" };

      // fallback
      const fallbackKey = metricKey === "gage_height_ft" ? "discharge_cfs" : "gage_height_ft";
      const fb = site?.[fallbackKey];
      if (fb?.series_7d?.length) {
        return { series: fb.series_7d, note: "Selected metric is missing. Showing " + (fallbackKey === "gage_height_ft" ? "stage feet" : "discharge cfs") + " instead." };
      }

      const n = wanted?.note || fb?.note || "No 7 day series available from this pull";
      return { series: [], note: n };
    }

    async function loadAll() {
      const risk = await getJson("data/composite_risk_score.json");
      const river = await getJson("data/river_status.json");
      const barge = await getJson("data/barge_status.json");
      const rail = await getJson("data/rail_status.json");

      document.getElementById("riskScore").textContent = fmt.format(risk.risk_score ?? 0);
      pillFor(risk.risk_level);
      document.getElementById("primaryDriver").textContent
