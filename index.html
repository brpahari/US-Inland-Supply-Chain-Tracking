<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>US Inland Logistics Risk Monitor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root { --bg: #0b0f14; --panel: #161b22; --border: #30363d; --text: #e7eef7; --mute: #8b949e; --accent: #3b82f6; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 20px; }
    
    header { border-bottom: 1px solid var(--border); padding-bottom: 20px; margin-bottom: 24px; }
    h1 { margin: 0; font-size: 26px; font-weight: 600; letter-spacing: -0.5px; }
    .badges { display: flex; gap: 12px; margin-top: 12px; font-size: 13px; color: var(--mute); flex-wrap: wrap; }
    .badge { background: #21262d; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border); }
    
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; }
    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
    .head { padding: 14px 18px; background: #21262d; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .label { font-weight: 600; font-size: 14px; color: #c9d1d9; }
    
    .chart-box { height: 240px; padding: 10px; position: relative; }
    .score-box { padding: 30px; text-align: center; }
    
    .big-score { font-size: 72px; font-weight: 700; margin-bottom: 8px; line-height: 1; }
    .risk-CRITICAL { color: #ef4444; }
    .risk-MODERATE { color: #f59e0b; }
    .risk-LOW { color: #10b981; }
    
    .driver-text { font-size: 14px; color: var(--mute); text-transform: uppercase; letter-spacing: 1px; }

    /* Tables */
    table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 0; }
    th, td { text-align: left; padding: 12px 16px; border-bottom: 1px solid var(--border); }
    th { color: var(--mute); font-weight: 500; font-size: 12px; text-transform: uppercase; }
    td.num { text-align: right; font-family: "SF Mono", Consolas, monospace; font-size: 14px; }

    /* Controls */
    select { background: #0d1117; color: var(--text); border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px; font-size: 12px; }
    button { background: #238636; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; }
    button:hover { background: #2ea043; }
    
    .overlay { position: absolute; inset: 0; background: rgba(11,15,20,0.9); display: flex; align-items: center; justify-content: center; color: #f59e0b; font-weight: 600; opacity: 0; pointer-events: none; transition: 0.2s; z-index: 10; }
    .overlay.show { opacity: 1; }
  </style>
</head>
<body>

<div class="wrap">
  <header>
    <h1>US Inland Logistics Risk Monitor</h1>
    <div class="badges" id="statusBadges">Loading...</div>
  </header>

  <div class="grid">
    <div class="panel">
      <div class="head"><div class="label">Composite Risk Score</div></div>
      <div class="score-box">
        <div class="big-score" id="riskScore">--</div>
        <div class="driver-text" id="riskLevel">Loading...</div>
        <div style="margin-top: 16px; font-size: 13px; color: var(--mute);">
          Primary Driver: <span id="primaryDriver" style="color: var(--text); font-weight: 600;">--</span>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="head"><div class="label">Risk Factors</div></div>
      <div class="chart-box"><canvas id="driverChart"></canvas></div>
    </div>

    <div class="panel">
      <div class="head"><div class="label">90-Day Risk Trend</div></div>
      <div class="chart-box">
        <canvas id="riskHistoryChart"></canvas>
        <div id="riskHistMsg" class="overlay">No History</div>
      </div>
    </div>

    <div class="panel">
      <div class="head">
        <div class="label">River Status</div>
        <div class="controls">
          <select id="riverSite">
            <option value="st_louis_mo">St. Louis, MO</option>
            <option value="memphis_tn">Memphis, TN</option>
          </select>
          <select id="riverMetric">
            <option value="gage_height_ft">Stage (ft)</option>
            <option value="discharge_cfs">Flow (cfs)</option>
          </select>
        </div>
      </div>
      <div class="chart-box">
        <canvas id="riverChart"></canvas>
        <div id="riverMsg" class="overlay">Data Unavailable (Try Flow)</div>
      </div>
    </div>

    <div class="panel">
      <div class="head"><div class="label">Locks 27 Volume (Count)</div></div>
      <div class="chart-box">
        <canvas id="bargeChart"></canvas>
        <div id="bargeMsg" class="overlay">No Data</div>
      </div>
    </div>

    <div class="panel">
      <div class="head">
        <div class="label">Rail Metrics</div>
        <div class="controls">
          <select id="railCarrier">
            <option value="UP">Union Pacific</option>
            <option value="BNSF">BNSF</option>
          </select>
          <select id="railMetric">
            <option value="terminal_dwell_hours">Dwell (hr)</option>
            <option value="train_speed_mph">Speed (mph)</option>
          </select>
        </div>
      </div>
      <div class="chart-box">
        <canvas id="railChart"></canvas>
        <div id="railMsg" class="overlay">No Data</div>
      </div>
    </div>
  </div>

  <div class="panel" style="margin-top: 24px; height: auto;">
    <div class="head">
      <div class="label">Signal Audit</div>
      <button id="refreshBtn">Refresh</button>
    </div>
    <table id="signalsTable">
      <thead><tr><th>Signal</th><th>Latest Value</th><th>Delta / Note</th></tr></thead>
      <tbody><tr><td colspan="3">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<script>
  const $ = id => document.getElementById(id);
  const safeNum = v => (v === null || v === undefined) ? null : Number(v);
  const ago = iso => iso ? ((new Date() - new Date(iso))/36e5).toFixed(1) + "h ago" : "--";

  // CSV Parser
  function parseCSV(txt) {
    if (!txt) return [];
    const lines = txt.trim().split('\n');
    if (lines.length < 2) return [];
    const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
    return lines.slice(1).map(line => {
      const row = line.split(',').map(c => c.trim().replace(/^"|"$/g, ''));
      const obj = {}; headers.forEach((h, i) => obj[h] = row[i]);
      return obj;
    });
  }

  // Chart Styling
  Chart.defaults.color = '#8b949e';
  Chart.defaults.borderColor = '#30363d';
  const commonOptions = {
    responsive: true, maintainAspectRatio: false,
    plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
    scales: { x: { display: false }, y: { border: { display: false }, grid: { display: false } } },
    elements: { point: { radius: 0, hitRadius: 10 }, line: { borderWidth: 2, tension: 0.3 } }
  };

  let charts = {};
  function renderChart(id, labels, data, color, type='line') {
    if (charts[id]) charts[id].destroy();
    const ctx = $(id).getContext('2d');
    
    // Gradient Fill
    const gradient = ctx.createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, color + '40'); // 25% opacity
    gradient.addColorStop(1, color + '00'); // 0% opacity

    charts[id] = new Chart(ctx, {
      type: type,
      data: {
        labels: labels,
        datasets: [{
          data: data,
          borderColor: color,
          backgroundColor: type==='line' ? gradient : color,
          fill: true
        }]
      },
      options: commonOptions
    });
  }

  function toggleOverlay(id, show) {
    const el = document.getElementById(id === 'riverChart' ? 'riverMsg' : id === 'railChart' ? 'railMsg' : id === 'bargeChart' ? 'bargeMsg' : 'riskHistMsg');
    if(el) el.className = show ? 'overlay show' : 'overlay';
  }

  // --- Loaders ---

  async function loadRiskHistory() {
    try {
      const r = await fetch('data/history/risk_daily.csv');
      if(!r.ok) throw new Error();
      const rows = parseCSV(await r.text());
      const dates = rows.map(r => r.timestamp_utc.slice(0,10));
      const vals = rows.map(r => parseFloat(r.risk_score));
      
      if(vals.length === 0) throw new Error();
      renderChart('riskHistoryChart', dates, vals, '#ef4444');
      toggleOverlay('riskHistoryChart', false);
    } catch { toggleOverlay('riskHistoryChart', true); }
  }

  async function loadBargeHistory() {
    try {
      const r = await fetch('data/history/barge_locks27_weekly.csv');
      if(!r.ok) throw new Error();
      const rows = parseCSV(await r.text());
      
      // DECLUTTER: Last 26 weeks only
      const recent = rows.slice(-26);
      
      const dates = recent.map(r => r.week_end_date);
      const vals = recent.map(r => parseFloat(r.total_barges || r.total_tons || 0));
      renderChart('bargeChart', dates, vals, '#f59e0b');
      toggleOverlay('bargeChart', false);
    } catch { toggleOverlay('bargeChart', true); }
  }

  async function loadRailHistory() {
    const carrier = $('railCarrier').value;
    const metric = $('railMetric').value;
    try {
      const r = await fetch('data/history/rail_weekly.csv');
      if(!r.ok) throw new Error();
      const rows = parseCSV(await r.text()).filter(r => r.carrier === carrier);
      
      // DECLUTTER: Last 26 weeks only
      const recent = rows.slice(-26);
      
      const dates = recent.map(r => r.week_end_date);
      const vals = recent.map(r => parseFloat(r[metric]));
      
      if(vals.length === 0) throw new Error();
      renderChart('railChart', dates, vals, '#3b82f6');
      toggleOverlay('railChart', false);
    } catch { toggleOverlay('railChart', true); }
  }

  // --- Main ---

  async function loadAll() {
    // 1. Load JSONs
    const [risk, river, barge, rail] = await Promise.all([
      fetch('data/composite_risk_score.json').then(r=>r.json()).catch(()=>({})),
      fetch('data/river_status.json').then(r=>r.json()).catch(()=>({})),
      fetch('data/barge_status.json').then(r=>r.json()).catch(()=>({})),
      fetch('data/rail_status.json').then(r=>r.json()).catch(()=>({}))
    ]);

    // 2. Score
    if(risk.risk_score !== undefined) {
      $('riskScore').innerText = Math.round(risk.risk_score);
      $('riskScore').className = 'big-score risk-' + risk.risk_level;
      $('riskLevel').innerText = risk.risk_level + " RISK";
      $('primaryDriver').innerText = (risk.primary_driver || 'None').toUpperCase();
    }
    
    // 3. Driver Chart
    if(risk.drivers) {
      renderChart('driverChart', risk.drivers.map(d=>d.name), risk.drivers.map(d=>d.score), '#3b82f6', 'bar');
    }

    // 4. River Chart (With Downsampling)
    const s = $('riverSite').value;
    const m = $('riverMetric').value;
    const series = river.sites?.[s]?.[m]?.series_7d;
    
    if(series && series.v && series.v.length > 0) {
      // DECLUTTER: Filter to every 16th point (~4 hour intervals)
      const dates = series.t_utc.filter((_, i) => i % 16 === 0);
      const vals = series.v.filter((_, i) => i % 16 === 0);
      
      renderChart('riverChart', dates, vals, '#10b981');
      toggleOverlay('riverChart', false);
    } else {
      toggleOverlay('riverChart', true);
    }

    // 5. Histories
    await loadRiskHistory();
    await loadBargeHistory();
    await loadRailHistory();

    // 6. Audit Table
    let html = '';
    
    // River
    const rData = river.sites?.[s]?.[m] || {};
    html += `<tr><td>St. Louis ${m==='gage_height_ft'?'Stage':'Flow'}</td><td class="num">${safeNum(rData.latest_value)?.toFixed(2)??'--'}</td><td class="num">7d Delta: ${safeNum(rData.delta_7d)?.toFixed(2)??'--'}</td></tr>`;
    
    // Barge
    const bData = barge.locks_27 || {};
    html += `<tr><td>Locks 27 Count</td><td class="num">${safeNum(bData.value)?.toFixed(0)??'--'}</td><td class="num">4w Delta: ${safeNum(bData.delta_4w)?.toFixed(0)??'--'}</td></tr>`;
    
    // Rail
    const rrData = rail.carriers?.[$('railCarrier').value]?.metrics?.[$('railMetric').value] || {};
    html += `<tr><td>${$('railCarrier').value} ${$('railMetric').value}</td><td class="num">${safeNum(rrData.value)?.toFixed(1)??'--'}</td><td class="num">4w Delta: ${safeNum(rrData.delta_4w)?.toFixed(1)??'--'}</td></tr>`;
    
    $('signalsTable').querySelector('tbody').innerHTML = html;
    
    // Badges
    $('statusBadges').innerHTML = `
      <div class="badge">Risk: ${ago(risk.generated_at_utc)}</div>
      <div class="badge">River: ${ago(river.generated_at_utc)}</div>
      <div class="badge">Barge: ${ago(barge.generated_at_utc)}</div>
    `;
  }

  $('riverSite').onchange = loadAll;
  $('riverMetric').onchange = loadAll;
  $('railCarrier').onchange = loadRailHistory;
  $('railMetric').onchange = loadRailHistory;
  $('refreshBtn').onclick = loadAll;

  loadAll();
</script>
</body>
</html>
