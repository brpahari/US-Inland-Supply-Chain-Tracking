<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>US Inland Logistics Risk Monitor</title>
  <meta name="description" content="Early warning supply chain dashboard for Mississippi River levels, barge traffic, and rail congestion." />
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, sans-serif; margin: 0; background: #0b0f14; color: #e7eef7; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 20px; }
    
    header { margin-bottom: 24px; border-bottom: 1px solid #2c3e50; padding-bottom: 16px; }
    h1 { font-size: 24px; margin: 0 0 8px 0; font-weight: 600; letter-spacing: -0.5px; }
    .sub { opacity: 0.7; font-size: 14px; }
    .badges { display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; font-size: 12px; }
    .badge { background: #1c2530; padding: 4px 8px; border-radius: 4px; color: #94a3b8; border: 1px solid #2c3e50; }
    .badge span { color: #fff; font-weight: 600; }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
    
    .panel { background: #161b22; border: 1px solid #30363d; border-radius: 6px; overflow: hidden; display: flex; flex-direction: column; }
    .head { background: #21262d; padding: 12px 16px; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center; }
    .label { font-weight: 600; font-size: 14px; color: #c9d1d9; }
    .chart-box { padding: 16px; height: 250px; position: relative; }
    .score-box { padding: 32px; text-align: center; }
    
    .big-score { font-size: 64px; font-weight: 700; line-height: 1; margin-bottom: 8px; }
    .risk-CRITICAL { color: #ef4444; }
    .risk-MODERATE { color: #f59e0b; }
    .risk-LOW { color: #10b981; }
    
    .driver-text { font-size: 16px; color: #8b949e; margin-top: 8px; }
    
    .controls { display: flex; gap: 10px; font-size: 12px; align-items: center; }
    select { background: #0d1117; color: #c9d1d9; border: 1px solid #30363d; padding: 4px; border-radius: 4px; }
    button { background: #238636; color: #fff; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    button:hover { background: #2ea043; }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { text-align: left; padding: 8px 12px; border-bottom: 1px solid #21262d; }
    th { color: #8b949e; font-weight: 600; }
    td.num { text-align: right; font-family: monospace; }
    
    .audit-section { margin-top: 40px; border-top: 1px solid #30363d; padding-top: 20px; }
    .audit-links a { color: #58a6ff; text-decoration: none; margin-right: 12px; font-size: 13px; }
    .audit-links a:hover { text-decoration: underline; }
  </style>
</head>
<body>

<div class="wrap">
  <header>
    <h1>US Inland Logistics Risk Monitor</h1>
    <div class="sub">Early warning dashboard for Mississippi River drafts, Locks 27 congestion, and Rail spillover.</div>
    <div class="badges" id="statusBadges">
      <div class="badge">Loading metadata...</div>
    </div>
  </header>

  <div class="grid">
    
    <div class="panel">
      <div class="head"><div class="label">Supply Chain Risk Score (0-100)</div></div>
      <div class="score-box">
        <div class="big-score" id="riskScore">--</div>
        <div class="driver-text" id="riskLevel">Loading...</div>
        <div class="driver-text" style="font-size: 13px; margin-top:12px;">
          Primary Driver: <span id="primaryDriver" style="color:#e7eef7">--</span>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="head"><div class="label">Risk Drivers (Contribution)</div></div>
      <div class="chart-box">
        <canvas id="driverChart"></canvas>
      </div>
    </div>

    <div class="panel">
      <div class="head"><div class="label">30-Day Risk Trend</div></div>
      <div class="chart-box">
        <canvas id="riskHistoryChart"></canvas>
      </div>
    </div>

    <div class="panel">
      <div class="head">
        <div class="label">River Stage (7 Days)</div>
        <div class="controls">
          <select id="riverSite">
            <option value="st_louis_mo">St. Louis, MO</option>
            <option value="memphis_tn">Memphis, TN</option>
          </select>
          <select id="riverMetric">
            <option value="gage_height_ft">Stage (ft)</option>
            <option value="discharge_cfs">Flow (cfs)</option>
          </select>
        </div>
      </div>
      <div class="chart-box">
        <canvas id="riverChart"></canvas>
      </div>
    </div>

    <div class="panel">
      <div class="head">
        <div class="label">Locks 27 Volume (Count)</div> 
      </div>
      <div class="chart-box">
        <canvas id="bargeChart"></canvas>
      </div>
    </div>

    <div class="panel">
      <div class="head">
        <div class="label">Rail Congestion History</div>
        <div class="controls">
          <select id="railCarrier">
            <option value="UP">Union Pacific</option>
            <option value="BNSF">BNSF</option>
          </select>
          <select id="railMetric">
            <option value="terminal_dwell_hours">Terminal Dwell (hr)</option>
            <option value="train_speed_mph">Train Speed (mph)</option>
          </select>
        </div>
      </div>
      <div class="chart-box">
        <canvas id="railChart"></canvas>
      </div>
    </div>

  </div> <div class="audit-section">
    <div class="head" style="background:none; border:none; padding-left:0;">
      <div class="label">Latest Signal Audit</div>
      <button id="refreshBtn">Refresh Data</button>
    </div>
    <div class="panel" style="height: auto;">
      <table id="signalsTable">
        <thead>
          <tr>
            <th>Signal</th>
            <th>Value</th>
            <th>Context / Delta</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="3">Loading...</td></tr>
        </tbody>
      </table>
    </div>
    <div class="audit-links" style="margin-top:12px;">
      Data Sources: 
      <a href="data/composite_risk_score.json" target="_blank">Risk JSON</a>
      <a href="data/river_status.json" target="_blank">River JSON</a>
      <a href="data/barge_status.json" target="_blank">Barge JSON</a>
      <a href="data/rail_status.json" target="_blank">Rail JSON</a>
    </div>
  </div>

</div>

<script>
  // --- UTILS ---
  const $ = id => document.getElementById(id);
  const safeNum = v => (v === null || v === undefined) ? null : Number(v);
  const hoursAgo = iso => {
    if(!iso) return "--";
    const diff = (new Date() - new Date(iso)) / 1000 / 3600;
    return diff.toFixed(2) + "h ago";
  };

  // --- CHART HELPERS ---
  let charts = {};
  
  function destroyChart(id) {
    if (charts[id]) { charts[id].destroy(); charts[id] = null; }
  }

  function makeLineChart(id, label, labels, data, color) {
    destroyChart(id);
    const ctx = $(id).getContext('2d');
    charts[id] = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: label,
          data: data,
          borderColor: color,
          backgroundColor: color + '10', // 10 = low opacity hex
          borderWidth: 2,
          pointRadius: 2,
          fill: true,
          tension: 0.2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { display: false }, // Clean look
          y: { 
            grid: { color: '#2c3e50' },
            ticks: { color: '#8b949e' }
          }
        }
      }
    });
  }

  function makeBarChart(id, labels, data) {
    destroyChart(id);
    const ctx = $(id).getContext('2d');
    charts[id] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Risk Contribution',
          data: data,
          backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'],
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, max: 100, grid: { color: '#2c3e50' } },
          x: { ticks: { color: '#8b949e' } }
        }
      }
    });
  }

  // --- LOADERS ---

  async function loadRiskHistory() {
    try {
      const r = await fetch('data/history/risk_daily.csv');
      if (!r.ok) throw new Error("No risk history");
      const text = await r.text();
      // Simple CSV Parse
      const lines = text.trim().split('\n').slice(1);
      const dates = [];
      const scores = [];
      
      lines.forEach(l => {
        const c = l.split(',');
        if(c.length >= 2) {
          dates.push(c[0].substring(0, 10)); // YYYY-MM-DD
          scores.push(parseFloat(c[1]));
        }
      });
      
      makeLineChart('riskHistoryChart', 'Risk Score', dates, scores, '#ef4444');
    } catch (e) {
      console.warn(e);
    }
  }

  async function loadBargeHistory() {
    try {
      const r = await fetch('data/history/barge_locks27_weekly.csv');
      if (!r.ok) throw new Error("No barge history");
      const text = await r.text();
      const lines = text.trim().split('\n').slice(1);
      const dates = [];
      const vals = [];
      
      lines.forEach(l => {
        const c = l.split(',');
        // csv: week_end_date, total_barges...
        if(c.length >= 2) {
          dates.push(c[0]);
          vals.push(parseFloat(c[1]));
        }
      });
      makeLineChart('bargeChart', 'Barges (Count)', dates, vals, '#f59e0b');
    } catch(e) {
      console.warn(e);
    }
  }

  async function loadRailHistoryForChart() {
    const carrier = $('railCarrier').value;
    const metric = $('railMetric').value; // train_speed_mph, terminal_dwell_hours
    
    try {
      const r = await fetch('data/history/rail_weekly.csv');
      if(!r.ok) return;
      const text = await r.text();
      const rows = text.trim().split('\n').slice(1);
      
      const dates = [];
      const vals = [];
      
      // Filter CSV logic
      // Header: week_end_date, carrier, train_speed_mph, terminal_dwell_hours...
      // We assume fixed index for simplicity or basic scan.
      // Scripts write: date(0), carrier(1), speed(2), dwell(3)
      
      const mIdx = metric === 'train_speed_mph' ? 2 : 3;
      
      rows.forEach(row => {
        const c = row.split(',');
        if (c[1] === carrier) {
          dates.push(c[0]);
          vals.push(parseFloat(c[mIdx]));
        }
      });
      
      makeLineChart('railChart', carrier + ' ' + metric, dates, vals, '#3b82f6');
      
    } catch (e) { console.warn(e); }
  }

  // --- MAIN LOAD SEQUENCE ---

  async function loadAll() {
    // 1. Fetch JSONs
    const [riskRes, riverRes, bargeRes, railRes] = await Promise.all([
      fetch('data/composite_risk_score.json').catch(()=>null),
      fetch('data/river_status.json').catch(()=>null),
      fetch('data/barge_status.json').catch(()=>null),
      fetch('data/rail_status.json').catch(()=>null)
    ]);

    const risk = riskRes ? await riskRes.json() : {};
    const river = riverRes ? await riverRes.json() : {};
    const barge = bargeRes ? await bargeRes.json() : {};
    const rail = railRes ? await railRes.json() : {};

    // 2. Render Risk Score Panel
    if (risk.risk_score !== undefined) {
      const el = $('riskScore');
      el.innerText = Math.round(risk.risk_score);
      el.className = 'big-score risk-' + risk.risk_level;
      $('riskLevel').innerText = risk.risk_level + " RISK";
      $('riskLevel').className = 'driver-text risk-' + risk.risk_level;
      $('primaryDriver').innerText = (risk.primary_driver || 'None').toUpperCase();
    }

    // 3. Render Driver Chart
    if (risk.drivers) {
      const labels = risk.drivers.map(d => d.name.toUpperCase());
      const data = risk.drivers.map(d => d.score);
      makeBarChart('driverChart', labels, data);
    }

    // 4. Render River Chart (Fixed Columnar Logic)
    const site = $('riverSite').value;
    const rMet = $('riverMetric').value;
    if (river.sites && river.sites[site] && river.sites[site][rMet]) {
      const seriesObj = river.sites[site][rMet].series_7d; // { t_utc: [], v: [] }
      if (seriesObj && seriesObj.t_utc && seriesObj.v) {
        makeLineChart('riverChart', rMet, seriesObj.t_utc, seriesObj.v, '#10b981');
      }
    }

    // 5. Render History Charts
    await loadRiskHistory();
    await loadBargeHistory();
    await loadRailHistoryForChart();

    // 6. Populate Table
    const tbody = $('signalsTable').querySelector('tbody');
    let html = '';

    // River Row
    const rSite = river.sites ? river.sites[$('riverSite').value] : null;
    if (rSite) {
      const gh = rSite.gage_height_ft || {};
      html += `<tr>
        <td>St. Louis Stage</td>
        <td class="num">${safeNum(gh.latest_value)?.toFixed(2)} ft</td>
        <td class="sub">7d Delta: ${safeNum(gh.delta_7d)?.toFixed(2)} ft</td>
      </tr>`;
    }

    // Barge Row
    const l27 = barge.locks_27 || {};
    html += `<tr>
      <td>Locks 27 Volume</td>
      <td class="num">${safeNum(l27.value)?.toFixed(0)}</td>
      <td class="sub">4w Delta: ${safeNum(l27.delta_4w)?.toFixed(0)} (Count)</td>
    </tr>`;

    // Rail Row
    const up = rail.carriers && rail.carriers.UP ? rail.carriers.UP.metrics : null;
    if (up) {
      const dw = up.terminal_dwell_hours || {};
      html += `<tr>
        <td>UP Terminal Dwell</td>
        <td class="num">${safeNum(dw.value)?.toFixed(1)} hr</td>
        <td class="sub">4w Delta: ${safeNum(dw.delta_4w)?.toFixed(1)} hr</td>
      </tr>`;
    }

    tbody.innerHTML = html;

    // 7. Update Badges (Timestamps)
    const times = [
      { l: 'Risk Score', t: risk.generated_at_utc },
      { l: 'River Data', t: river.generated_at_utc },
      { l: 'Barge Data', t: barge.generated_at_utc },
      { l: 'Rail Data', t: rail.generated_at_utc }
    ];
    
    let badgesHtml = '';
    times.forEach(x => {
      if (x.t) badgesHtml += `<div class="badge">${x.l}: <span>${hoursAgo(x.t)}</span></div>`;
    });
    $('statusBadges').innerHTML = badgesHtml;
  }

  // --- EVENT LISTENERS ---
  $('riverSite').addEventListener('change', loadAll);
  $('riverMetric').addEventListener('change', loadAll);
  $('railCarrier').addEventListener('change', loadRailHistoryForChart);
  $('railMetric').addEventListener('change', loadRailHistoryForChart);
  $('refreshBtn').addEventListener('click', loadAll);

  // Init
  loadAll();

</script>
</body>
</html>
